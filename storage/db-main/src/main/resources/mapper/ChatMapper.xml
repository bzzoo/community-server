<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.app.community.storage.db.query.ChatMapper">

    <!-- 회원 ID로 채팅 목록 조회 -->
    <select id="findChatListByMemberId" resultMap="ChatInfoMap">
        SELECT
            c.id as chatId,
            r.id as requesterId,
            r.nickname as requesterNickname,
            s.id as respondentId,
            s.nickname as respondentNickname,
            m.content as lastMessageContent,
            m.created_at as lastMessageCreatedAt,
            c.created_at as chatCreatedAt,
            c.end_at as chatEndAt
        FROM
            chat c
                LEFT JOIN message m ON m.id = (
                SELECT MAX(id)
                FROM message
                WHERE chat_id = c.id
            )
                LEFT JOIN member r ON c.requester_id = r.id
                LEFT JOIN member s ON c.respondent_id = s.id
        WHERE
            c.requester_id = #{memberId}
           OR c.respondent_id = #{memberId}
    </select>

    <!-- 채팅 메시지 목록 조회 -->
    <select id="findChatMessageList" resultMap="ChatMessageInfoMap">
        SELECT
        m.id as messageId,
        m.chat_id as chatId,
        s.id as senderId,
        s.nickname as senderNickname,
        m.content,
        m.created_at as messageCreatedAt,
        m.message_type as messageType,
        m.is_read as isRead
        FROM
        message m
        LEFT JOIN member s ON m.sender_id = s.id
        WHERE
        m.chat_id = #{chatId}
        <if test="cursor != null and cursor != -1">
            AND m.id &lt; #{cursor}
        </if>
        ORDER BY m.id DESC
        LIMIT 21
    </select>

    <!-- Result Map Definitions -->
    <resultMap id="ChatInfoMap" type="ChatInfo">
        <!-- 먼저 ID 요소 정의 -->
        <id column="chatId" property="chatId"/>

        <!-- 그다음 result 요소 정의 -->
        <result column="lastMessageContent" property="lastMessages"/>
        <result column="lastMessageCreatedAt" property="lastUpdatedAt"/>
        <result column="chatCreatedAt" property="createdAt"/>
        <result column="chatEndAt" property="endDate"/>

        <!-- 그다음 association 요소 정의 -->
        <association property="sender" javaType="Participant">
            <id column="requesterId" property="memberId"/>
            <result column="requesterNickname" property="nickname"/>
        </association>

        <association property="receiver" javaType="Participant">
            <id column="respondentId" property="memberId"/>
            <result column="respondentNickname" property="nickname"/>
        </association>
    </resultMap>

    <resultMap id="ChatMessageInfoMap" type="ChatMessageInfo">
        <!-- 먼저 ID 요소 정의 -->
        <id column="messageId" property="messageId"/>

        <!-- 그다음 result 요소 정의 -->
        <result column="chatId" property="chatId"/>
        <result column="content" property="content"/>
        <result column="messageCreatedAt" property="createdAt"/>
        <result column="messageType" property="messageType"/>
        <result column="isRead" property="isRead"/>

        <!-- 그다음 association 요소 정의 -->
        <association property="sender" javaType="Participant">
            <id column="senderId" property="memberId"/>
            <result column="senderNickname" property="nickname"/>
        </association>
    </resultMap>

</mapper>
