<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.app.community.storage.db.query.CommentMapper">

    <!-- 특정 Article ID로 댓글 목록 조회 -->
    <select id="findCommentListByArticleId" resultMap="CommentInfoMap">
        SELECT
        c.id as commentId,
        c.article_id as articleId,
        c.parent_comment_id as parentId,
        c.content,
        c.status,
        c.created_at as createdAt,
        c.updated_at as updatedAt,
        m.id as memberId,
        m.nickname,
        m.profile_image_path as profileImagePath,
        m.created_at as memberCreatedAt,
        m.updated_at as memberUpdatedAt,
        child.id as childCommentId,
        child.content as childContent,
        child.created_at as childCreatedAt,
        child.updated_at as childUpdatedAt,
        child.status as childStatus,
        childMember.id as childMemberId,
        childMember.nickname as childMemberNickname,
        childMember.profile_image_path as childMemberProfileImagePath,
        childMember.created_at as childMemberCreatedAt,
        childMember.updated_at as childMemberUpdatedAt
        FROM
        comment c
        LEFT JOIN member m ON c.writer_id = m.id
        LEFT JOIN comment child ON child.parent_comment_id = c.id
        LEFT JOIN member childMember ON child.writer_id = childMember.id
        WHERE
        c.article_id = #{articleId}
        AND c.parent_comment_id IS NULL
        <if test="cursor != null and cursor != -1">
            AND c.id &lt; #{cursor}
        </if>
        ORDER BY c.created_at ASC
        LIMIT 41
    </select>

    <!-- 회원의 답글 목록 조회 -->
    <select id="findAnswerByMember" resultMap="ProfileCommentMap">
        SELECT
        c.id as commentId,
        c.article_id as articleId,
        a.title as articleTitle,
        c.content,
        c.status,
        c.created_at as createdAt,
        c.updated_at as updatedAt
        FROM
        comment c
        LEFT JOIN article a ON a.id = c.article_id
        WHERE
        c.writer_id = #{memberId}
        AND c.parent_comment_id IS NULL
        <if test="cursor != null and cursor != -1">
            AND c.id &lt; #{cursor}
        </if>
        ORDER BY c.id DESC
        LIMIT 20
    </select>

    <!-- Result Map Definitions -->
    <resultMap id="CommentInfoMap" type="CommentInfo">
        <id column="commentId" property="commentId"/>
        <result column="articleId" property="articleId"/>
        <result column="parentId" property="parentId"/>
        <result column="content" property="content"/>
        <result column="status" property="status"/>
        <result column="createdAt" property="createdAt"/>
        <result column="updatedAt" property="updatedAt"/>

        <!-- Author 정보 매핑 -->
        <association property="author" javaType="CommentAuthor">
            <id column="memberId" property="memberId"/>
            <result column="nickname" property="nickname"/>
            <result column="profileImagePath" property="profileImagePath"/>
            <result column="memberCreatedAt" property="createdAt"/>
            <result column="memberUpdatedAt" property="updatedAt"/>
        </association>

        <!-- 자식 댓글 목록 매핑 -->
        <collection property="childCommentList" ofType="CommentInfo">
            <id column="childCommentId" property="commentId"/>
            <result column="articleId" property="articleId"/>
            <result column="content" property="content"/>
            <result column="status" property="status"/>
            <result column="createdAt" property="createdAt"/>
            <result column="updatedAt" property="updatedAt"/>

            <!-- 자식 댓글 작성자 정보 매핑 -->
            <association property="author" javaType="CommentAuthor">
                <id column="childMemberId" property="memberId"/>
                <result column="childMemberNickname" property="nickname"/>
                <result column="childMemberProfileImagePath" property="profileImagePath"/>
                <result column="childMemberCreatedAt" property="createdAt"/>
                <result column="childMemberUpdatedAt" property="updatedAt"/>
            </association>
        </collection>
    </resultMap>

    <resultMap id="ProfileCommentMap" type="ProfileComment">
        <id column="commentId" property="commentId"/>
        <result column="articleId" property="articleId"/>
        <result column="articleTitle" property="articleTitle"/>
        <result column="content" property="content"/>
        <result column="status" property="status"/>
        <result column="createdAt" property="createdAt"/>
        <result column="updatedAt" property="updatedAt"/>
    </resultMap>

</mapper>
